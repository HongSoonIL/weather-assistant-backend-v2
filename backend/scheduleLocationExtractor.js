// scheduleLocationExtractor.js
const { extractDateFromText } = require('./timeUtils');

/**
 * ì¼ì • í…ìŠ¤íŠ¸ì—ì„œ ì§€ì—­ëª…ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
 * @param {string} scheduleText - ì¼ì • í…ìŠ¤íŠ¸ (ì˜ˆ: "2025-12-16: ì„±ìˆ˜ ì¹´í˜ íƒë°©")
 * @returns {string|null} - ì¶”ì¶œëœ ì§€ì—­ëª… ë˜ëŠ” null
 */
function extractLocationFromSchedule(scheduleText) {
  // ì£¼ìš” í•œêµ­ ì§€ì—­ëª… ëª©ë¡ (í•„ìš”ì— ë”°ë¼ í™•ì¥ ê°€ëŠ¥)
  const locationKeywords = [
    // ì„œìš¸ ì§€ì—­êµ¬ ë° ì£¼ìš” ëª…ì†Œ
    'ê°•ë‚¨', 'ê°•ë¶', 'ê°•ì„œ', 'ê°•ë™', 'ê´€ì•…', 'ê´‘ì§„', 'êµ¬ë¡œ', 'ê¸ˆì²œ', 'ë…¸ì›',
    'ë„ë´‰', 'ë™ëŒ€ë¬¸', 'ë™ì‘', 'ë§ˆí¬', 'ì„œëŒ€ë¬¸', 'ì„œì´ˆ', 'ì„±ë™', 'ì„±ë¶', 'ì†¡íŒŒ',
    'ì–‘ì²œ', 'ì˜ë“±í¬', 'ìš©ì‚°', 'ì€í‰', 'ì¢…ë¡œ', 'ì¤‘êµ¬', 'ì¤‘ë‘',
    'ì„±ìˆ˜', 'í™ëŒ€', 'ì‹ ì´Œ', 'ì´íƒœì›', 'ëª…ë™', 'ì ì‹¤', 'ì—¬ì˜ë„', 'ì••êµ¬ì •', 'ì²­ë‹´',
    
    // ê´‘ì—­ì‹œ
    'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…',
    
    // ê²½ê¸°ë„
    'ìˆ˜ì›', 'ì„±ë‚¨', 'ê³ ì–‘', 'ìš©ì¸', 'ë¶€ì²œ', 'ì•ˆì‚°', 'ì•ˆì–‘', 'ë‚¨ì–‘ì£¼', 'í™”ì„±',
    'í‰íƒ', 'ì˜ì •ë¶€', 'ì‹œí¥', 'íŒŒì£¼', 'ê¹€í¬', 'ê´‘ëª…', 'ê´‘ì£¼', 'êµ°í¬', 'ì˜¤ì‚°',
    'ì´ì²œ', 'ì–‘ì£¼', 'ì•ˆì„±', 'êµ¬ë¦¬', 'í¬ì²œ', 'ì˜ì™•', 'í•˜ë‚¨', 'ì—¬ì£¼', 'ë™ë‘ì²œ',
    'ê³¼ì²œ', 'ê°€í‰', 'ì–‘í‰', 'ì—°ì²œ',
    
    // ê°•ì›ë„
    'ì¶˜ì²œ', 'ì›ì£¼', 'ê°•ë¦‰', 'ë™í•´', 'íƒœë°±', 'ì†ì´ˆ', 'ì‚¼ì²™', 'í™ì²œ', 'íš¡ì„±', 'ì˜ì›”', 'í‰ì°½', 'ì •ì„ ', 'ì² ì›', 'í™”ì²œ', 'ì–‘êµ¬', 'ì¸ì œ', 'ê³ ì„±', 'ì–‘ì–‘', 'ì„¤ì•…ì‚°', 'ê²½í¬ëŒ€',
    
    // ì¶©ì²­ë„
    'ì²œì•ˆ', 'ì²­ì£¼', 'ê³µì£¼', 'ë³´ë ¹', 'ì•„ì‚°', 'ì„œì‚°', 'ë…¼ì‚°', 'ê³„ë£¡', 'ë‹¹ì§„', 'ê¸ˆì‚°', 'ë¶€ì—¬', 'ì„œì²œ', 'ì²­ì–‘', 'í™ì„±', 'ì˜ˆì‚°', 'íƒœì•ˆ', 'ì¶©ì£¼', 'ì œì²œ', 'ë‹¨ì–‘', 'ìŒì„±', 'ì§„ì²œ', 'ê´´ì‚°', 'ì¦í‰', 'ì˜ë™', 'ì˜¥ì²œ',
    
    // ì „ë¼ë„
    'ì „ì£¼', 'êµ°ì‚°', 'ìµì‚°', 'ì •ì', 'ë‚¨ì›', 'ê¹€ì œ', 'ì™„ì£¼', 'ì§„ì•ˆ', 'ë¬´ì£¼', 'ì¥ìˆ˜', 'ì„ì‹¤', 'ìˆœì°½', 'ê³ ì°½', 'ë¶€ì•ˆ', 'ëª©í¬', 'ì—¬ìˆ˜', 'ìˆœì²œ', 'ë‚˜ì£¼', 'ê´‘ì–‘', 'ë‹´ì–‘', 'ê³¡ì„±', 'êµ¬ë¡€', 'ê³ í¥', 'ë³´ì„±', 'í™”ìˆœ', 'ì¥í¥', 'ê°•ì§„', 'í•´ë‚¨', 'ì˜ì•”', 'ë¬´ì•ˆ', 'í•¨í‰', 'ì˜ê´‘', 'ì¥ì„±', 'ì™„ë„', 'ì§„ë„', 'ì‹ ì•ˆ',
    
    // ê²½ìƒë„
    'í¬í•­', 'ê²½ì£¼', 'ê¹€ì²œ', 'ì•ˆë™', 'êµ¬ë¯¸', 'ì˜ì£¼', 'ì˜ì²œ', 'ìƒì£¼', 'ë¬¸ê²½', 'ê²½ì‚°', 'ì˜ì„±', 'ì²­ì†¡', 'ì˜ì–‘', 'ì˜ë•', 'ì²­ë„', 'ê³ ë ¹', 'ì„±ì£¼', 'ì¹ ê³¡', 'ì˜ˆì²œ', 'ë´‰í™”', 'ìš¸ì§„', 'ìš¸ë¦‰', 'ì°½ì›', 'ì§„ì£¼', 'í†µì˜', 'ì‚¬ì²œ', 'ê¹€í•´', 'ë°€ì–‘', 'ê±°ì œ', 'ì–‘ì‚°', 'ì˜ë ¹', 'í•¨ì•ˆ', 'ì°½ë…•', 'ê³ ì„±', 'ë‚¨í•´', 'í•˜ë™', 'ì‚°ì²­', 'í•¨ì–‘', 'ê±°ì°½', 'í•©ì²œ',
    
    // ì œì£¼
    'ì œì£¼', 'ì„œê·€í¬', 'ì• ì›”', 'í•œë¦¼', 'ìš°ë„', 'ì„±ì‚°'
  ];

  for (const location of locationKeywords) {
    if (scheduleText.includes(location)) {
      return location;
    }
  }
  
  return null;
}

/**
 * ì‚¬ìš©ì í”„ë¡œí•„ì˜ ì¼ì •ì—ì„œ ë‚ ì§œì™€ ë§¤ì¹­ë˜ëŠ” ì§€ì—­ì„ ì°¾ëŠ” í•¨ìˆ˜
 * ğŸ”¥ ìˆ˜ì •ì‚¬í•­: ì—°ë„(Year)ê°€ ë‹¬ë¼ë„ ì›”/ì¼(MM-DD)ì´ ì¼ì¹˜í•˜ë©´ ë§¤ì¹­ë˜ë„ë¡ ìœ ì—°ì„± ì¶”ê°€
 * @param {Object} userProfile - ì‚¬ìš©ì í”„ë¡œí•„ (schedule í¬í•¨)
 * @param {Date} targetDate - ëŒ€ìƒ ë‚ ì§œ ê°ì²´
 * @returns {string|null} - ì¶”ì¶œëœ ì§€ì—­ëª… ë˜ëŠ” null
 */
function getLocationFromSchedule(userProfile, targetDate) {
  if (!userProfile || !userProfile.schedule) {
    return null;
  }

  const scheduleText = userProfile.schedule;
  
  // 1. ì •í™•í•œ ë‚ ì§œ í¬ë§· (YYYY-MM-DD) - ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ìƒì„±
  const year = targetDate.getFullYear();
  const month = String(targetDate.getMonth() + 1).padStart(2, '0');
  const day = String(targetDate.getDate()).padStart(2, '0');
  const fullDateStr = `${year}-${month}-${day}`;
  
  // 2. ì›”-ì¼ í¬ë§· (MM-DD) - ì—°ë„ê°€ ë‹¬ë¼ë„ ë§¤ì¹­í•˜ê¸° ìœ„í•¨ (ì˜ˆ: 2024-12-16 ìš”ì²­ -> 2025-12-16 ì¼ì • ë§¤ì¹­)
  const monthDayStr = `${month}-${day}`;
  
  // 3. ë‹¤ë¥¸ í¬ë§· (M/D)
  const shortDateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;

  console.log(`ğŸ” ì¼ì • ê²€ìƒ‰ í‚¤ì›Œë“œ: [${fullDateStr}], [-${monthDayStr}], [${shortDateStr}]`);
  
  // ì¼ì •ì„ ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ì—¬ ë°°ì—´ë¡œ ë§Œë“¦
  const scheduleItems = scheduleText.split(',').map(item => item.trim());
  
  for (const item of scheduleItems) {
    // ë‚ ì§œ ë§¤ì¹­ í™•ì¸ ë¡œì§ ê°•í™”:
    // 1) YYYY-MM-DDê°€ ì™„ì „íˆ ì¼ì¹˜í•˜ê±°ë‚˜
    // 2) YYYY-MM-DD í¬ë§·ì˜ ë‚ ì§œ ì¤‘ MM-DD ë¶€ë¶„ë§Œ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ë‹¤ë¥¸ ì—°ë„ í—ˆìš©)
    // 3) M/D í¬ë§·ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
    const isDateMatched = 
      item.includes(fullDateStr) || 
      (item.match(/\d{4}-(\d{2}-\d{2})/) && item.includes(`-${monthDayStr}`)) ||
      item.includes(shortDateStr);

    if (isDateMatched) {
      console.log('âœ… ì¼ì • ë‚ ì§œ ë§¤ì¹­ ì„±ê³µ:', item);
      
      // í•´ë‹¹ ì¼ì • í…ìŠ¤íŠ¸ì—ì„œ ì§€ì—­ëª… ì¶”ì¶œ
      const location = extractLocationFromSchedule(item);
      if (location) {
        console.log('ğŸ“ ì¼ì •ì—ì„œ ì§€ì—­ ì¶”ì¶œ ì„±ê³µ:', location);
        return location;
      }
    }
  }
  
  console.log('âŒ í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ì—ì„œ ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  return null;
}

/**
 * (êµ¬ë²„ì „ í˜¸í™˜ìš©) ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ ë‚ ì§œë¥¼ ì¶”ì¶œí•˜ê³ , í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ì—ì„œ ì§€ì—­ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
 */
function extractScheduleContext(userInput, userProfile) {
  const targetDate = extractDateFromText(userInput);
  const location = getLocationFromSchedule(userProfile, targetDate);
  
  return {
    date: targetDate,
    location: location
  };
}

module.exports = {
  extractLocationFromSchedule,
  getLocationFromSchedule,
  extractScheduleContext
};