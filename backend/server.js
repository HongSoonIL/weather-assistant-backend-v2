// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// require('dotenv').config();
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const express = require('express');
const cors = require('cors');
const axios = require('axios');
const bodyParser = require('body-parser');

const app = express();
const PORT = 4000;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì¤‘ìš”í•œ API í‚¤ë“¤ì€ ì‹¤ì œ ë°°í¬ ì‹œ .envì— ë„£ìœ¼ì„¸ìš” (ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¥¼ ìœ„í•´ í•˜ë“œì½”ë”©).
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GEMINI_API_KEY = 'AIzaSyAsxn4RLgLzEc8FuuEh9F5fo4JzQp9YjZo';
const OPENWEATHER_API_KEY = 'a72c7174a9b30d55f73d52a104868e49';
const GOOGLE_MAPS_API_KEY = 'AIzaSyAiZGWeaxSGW5pHHl7DvlMFp80y_pnO1Fg';

app.use(cors());
app.use(bodyParser.json());

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) Reverse Geocoding: ìœ„ë„Â·ê²½ë„ â†’ â€œë„ì‹œ, êµ­ê°€â€ ë°˜í™˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/reverse-geocode', async (req, res) => {
  const { latitude, longitude } = req.body;

  try {
    const response = await axios.get(
      'https://maps.googleapis.com/maps/api/geocode/json',
      {
        params: {
          latlng: `${latitude},${longitude}`,
          key: GOOGLE_MAPS_API_KEY,
          language: 'ko'  // í•œê¸€ ì£¼ì†Œë¥¼ ì›í•˜ë©´ 'ko' ë¡œ ë°”ê¿”ì£¼ì„¸ìš”
        }
      }
    );

    const results = response.data.results;
    if (!Array.isArray(results) || results.length === 0) {
      return res.status(404).json({ error: 'ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const components = results[0].address_components;
    const city = components.find(c =>
      c.types.includes('locality') ||
      c.types.includes('administrative_area_level_1')
    )?.long_name;

    const country = components.find(c =>
      c.types.includes('country')
    )?.short_name;

    const region = city && country
      ? `${city}, ${country}`
      : 'Unknown';

    res.json({ region });
  } catch (error) {
    console.error('ğŸ“ Google Geocoding ì‹¤íŒ¨:', error.message);
    res.status(500).json({ error: 'ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨' });
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2) getWeatherByCoords: ìœ„ë„Â·ê²½ë„ â†’ OpenWeatherì—ì„œ ë‚ ì”¨ ì •ë³´ ë¦¬í„´
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getWeatherByCoords(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/weather`;
  const response = await axios.get(url, {
    params: {
      lat,
      lon,
      appid: OPENWEATHER_API_KEY,
      units: 'metric',
      lang: 'kr'
    }
  });
  const data = response.data;
  return {
    temp: Math.round(data.main.temp),
    condition: data.weather[0].description,
    humidity: data.main.humidity,
    wind: data.wind.speed
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3) getSeoulWeather: 'ì„œìš¸' ê³ ì • ì¡°íšŒ (í•„ìš” ì‹œ ê·¸ëŒ€ë¡œ ë‘ì…”ë„ ë©ë‹ˆë‹¤)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getSeoulWeather() {
  const url = `https://api.openweathermap.org/data/2.5/weather`;
  const response = await axios.get(url, {
    params: {
      q: 'Seoul',
      appid: OPENWEATHER_API_KEY,
      units: 'metric',
      lang: 'kr'
    }
  });
  const data = response.data;
  return {
    temp: Math.round(data.main.temp),
    condition: data.weather[0].description,
    humidity: data.main.humidity,
    wind: data.wind.speed
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4) /gemini ì—”ë“œí¬ì¸íŠ¸: â€œcoordsê°€ ìˆê³  userInputì— 'ë‚ ì”¨'ë§Œ ë“¤ì–´ê°€ë©´ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨â€
//                       â€œì„œìš¸+ë‚ ì”¨"ë©´ ì„œìš¸ ì •ë³´, ê·¸ ì™¸ëŠ” ì¼ë°˜ Gemini ì§ˆë¬¸.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/gemini', async (req, res) => {
  // userInput, location(ì˜ˆ: "ê³ ì–‘ì‹œ, KR"), coords({ latitude, longitude }) ë¥¼ bodyì—ì„œ ë°›ìŒ
  const { userInput, location, coords } = req.body;
  console.log('ğŸ“© POST /gemini ìš”ì²­ ìˆ˜ì‹ ë¨');
  console.log('ğŸ’¬ ì‚¬ìš©ì ì§ˆë¬¸:', userInput);

  try {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4-1) â€œcoordsê°€ ì¡´ì¬â€ + â€œë‚ ì”¨â€ í¬í•¨ â†’ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ì¡°íšŒ ë¶„ê¸°
    //      (ì´ì œ â€œí˜„ì¬ ìœ„ì¹˜â€ í‚¤ì›Œë“œ ì—†ì´ë„ ë™ì‘í•¨)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (
      coords?.latitude != null &&
      coords?.longitude != null &&
      typeof userInput === 'string' &&
      userInput.includes('ë‚ ì”¨')
    ) {
      const weather = await getWeatherByCoords(coords.latitude, coords.longitude);
      const place = location || 'ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜';

      // Gemini prompt ìƒì„±
      const prompt = `
ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ëŠ” ${place}ì…ë‹ˆë‹¤. (ìœ„ë„: ${coords.latitude}, ê²½ë„: ${coords.longitude})
ë‹¤ìŒì€ ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ì…ë‹ˆë‹¤:
- ê¸°ì˜¨: ${weather.temp}ë„
- ìƒíƒœ: ${weather.condition}
- ìŠµë„: ${weather.humidity}%
- í’ì†: ${weather.wind}m/s

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì¹œê·¼í•œ ë§íˆ¬ë¡œ ì˜¤ëŠ˜ ë‚ ì”¨ ìš”ì•½ê³¼ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.
ë‹µë³€ì€ 3~4ë¬¸ì¥ ì´ë‚´ë¡œ, ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ì¨ì£¼ì„¸ìš”. ë¬¸ì¥ ë§ˆì§€ë§‰ì— ì´ëª¨ì§€ë„ ë¶™ì—¬ì£¼ì„¸ìš”.
      `;

      const result = await axios.post(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
        {
          contents: [{ parts: [{ text: prompt }] }]
        }
      );
      let raw = result.data.candidates?.[0]?.content?.parts?.[0]?.text || '';

      // (í•„ìš”í•˜ë‹¤ë©´ Markdown ì œê±° + <br/> ì‚½ì… â†’ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
      // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ raw ìƒíƒœë¡œ ë‚´ë ¤ë³´ê² ìŠµë‹ˆë‹¤.
      return res.json({ reply: raw });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4-2) â€œì„œìš¸ + ë‚ ì”¨â€ ë¶„ê¸°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (
      typeof userInput === 'string' &&
      userInput.includes('ì„œìš¸') &&
      userInput.includes('ë‚ ì”¨')
    ) {
      const weather = await getSeoulWeather();
      const prompt = `
ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì„œìš¸ ë‚ ì”¨ì— ëŒ€í•´ ë¬¼ì–´ë´¤ìŠµë‹ˆë‹¤.
í˜„ì¬ ë‚ ì”¨ ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
- ê¸°ì˜¨: ${weather.temp}ë„
- ìƒíƒœ: ${weather.condition}
- ìŠµë„: ${weather.humidity}%
- í’ì†: ${weather.wind}m/s

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì¹œê·¼í•œ ë§íˆ¬ë¡œ ì˜¤ëŠ˜ ë‚ ì”¨ ìš”ì•½ê³¼ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.
ë‹µë³€ì€ 3~4ë¬¸ì¥ ì´ë‚´ë¡œ, ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ì¨ì£¼ì„¸ìš”. ë¬¸ì¥ ë§ˆì§€ë§‰ì— ì´ëª¨ì§€ë¥¼ ë¶™ì—¬ì£¼ì„¸ìš”.
      `;
      const result = await axios.post(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
        {
          contents: [{ parts: [{ text: prompt }] }]
        }
      );
      const raw = result.data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      console.log('[ğŸŒ¤ï¸ Gemini ë‚ ì”¨ ì‘ë‹µ]', raw);
      return res.json({ reply: raw });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4-3) ê·¸ ì™¸ ì¼ë°˜ ì§ˆë¬¸ â†’ Geminië¡œ ê·¸ëŒ€ë¡œ ì „ë‹¬
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const result = await axios.post(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
      {
        contents: [{ parts: [{ text: userInput }] }]
      }
    );
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5) í…ìŠ¤íŠ¸ í´ë Œì§•
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const raw = result.data.candidates?.[0]?.content?.parts?.[0]?.text || '';    
    // 1) ë³¼ë“œ ë§ˆí¬ë‹¤ìš´ ì œê±°
    let formatted = raw.replace(/\*\*/g, '');

    // 2) â€œâ€¢ â€ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì•ë’¤ ê³µë°± ì œê±°
    const parts = formatted
      .split('â€¢ ')
      .map(s => s.trim())
      .filter(s => s.length > 0);

    // 3) ì²« ì¤„(ì†Œê°œ ë¬¸ì¥)ê³¼ ë‚˜ë¨¸ì§€ í•­ëª©ì„ êµ¬ë¶„í•´ì„œ ì¬ì¡°í•©
    const header = parts.shift();
    const items = parts.map(p => `- ${p}`);

    // 4) â€œì˜¤ëŠ˜ ì˜ˆìƒ ë‚ ì”¨:â€ ì•ë’¤ë¡œ ë¹ˆ ì¤„ ì¶”ê°€
    const idx = items.findIndex(p => p.startsWith('ì˜¤ëŠ˜ ì˜ˆìƒ ë‚ ì”¨:'));
    if (idx !== -1) {
      items[idx] = `\n${items[idx]}`;
    }

    // 5) ìµœì¢… ë¬¸ìì—´ ë§Œë“¤ê¸°
    formatted = [
      header,
      ...items
    ].join('\n');

    // 6) ì‘ë‹µìœ¼ë¡œ ë³´ë‚´ê¸°
    res.json({ reply: formatted });

  } catch (err) {
    console.error('âŒ Gemini API ì˜¤ë¥˜ ë°œìƒ!');
    console.error('â†³ ìƒíƒœ ì½”ë“œ:', err.response?.status);
    console.error('â†³ ì‘ë‹µ ë°ì´í„°:', JSON.stringify(err.response?.data, null, 2));
    return res.status(err.response?.status || 500).json({
      error: 'Gemini API í˜¸ì¶œ ì‹¤íŒ¨',
      message: err.response?.data?.error?.message || err.message
    });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… Gemini ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
});